# smart_elevator
Система управления лифтом
### Техническое задание: Асинхронная система управления лифтом с оптимизацией маршрутов
Общее описание
Необходимо разработать асинхронное веб-API на FastAPI для управления умным лифтом, который может обрабатывать множественные вызовы с разных этажей и оптимизировать свой маршрут.
Функциональные требования
1. Эндпоинт вызова лифта
   POST /call/
   Параметры:
   •	floor: int (обязательный) - номер этажа, с которого вызывается лифт
   Логика:
   •	Добавляет вызов в очередь планировщика
   •	Возвращает немедленный ответ (не ждет приезда лифта)
2. Эндпоинт выбора этажа назначения
   POST /select/
   Параметры:
   •	floor: int (обязательный) - этаж назначения
   Логика:
   •	Работает ТОЛЬКО если лифт в данный момент находится на этаже, с которого был вызван
   •	Добавляет этаж назначения в маршрут лифта
   •	Система сама определяет, с какого этажа был вызов на основе текущего положения лифта
3. Эндпоинт статуса системы
   GET /status/
   Ответ:
   •	Текущее состояние лифта
   •	Текущий этаж
   •	Направление движения
   •	Текущий маршрут (ближайшие этажи в порядке посещения)

## Возможности

- Вызов лифта с любого этажа с немедленным ответом
- Выбор этажа назначения, когда лифт прибыл на этаж вызова
- Асинхронное движение лифта и оптимизация маршрута (SCAN)
- Эндпоинт статуса текущего состояния

## Быстрый старт (локально)

Требуется Python 3.12+.

- Установка зависимостей (Poetry):
    - Убедитесь, что установлен Poetry: `pip install poetry`
    - Установка: `poetry install`
- Запуск сервера:
    - `uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload`

Откройте `http://127.0.0.1:8000/docs` для Swagger UI.

## Запуск в Docker

Рекомендуется базовый образ Python 3.12 (упрощает установку зависимостей веб-сервера).

- Собрать образ:
    - `docker build -t smart-elevator .`
- Запустить контейнер:
    - `docker run -p 8000:8000 smart-elevator`

С docker-compose:
- `docker-compose up --build`

Примечание: при монтировании `./app:/app/app` код внутри контейнера будет перекрыт локальным (удобно для разработки).

## API

Базовый URL: `http://localhost:8000`

### POST /call
Вызов лифта на указанный этаж.

- Тело запроса:
```json
{ "floor": 5 }
```

- Успешный ответ (пример):
```json
{
  "message": "Лифт вызван на 5 этаж",
  "current_floor": 1,
  "status": "Вызов принят"
}
```

### POST /select
Выбор этажа назначения. Доступно только когда лифт находится на этаже, с которого его вызывали (двери «открыты»).

- Тело запроса:
```json
{ "floor": 10 }
```

- Успешный ответ (пример):
```json
{
  "message": "Этаж 10 добавлен в маршрут",
  "current_floor": 5,
  "status": "Вы выбрали этаж"
}
```

- Ошибка, если выбор недоступен (пример):
```json
{
  "detail": "Можно выбирать этаж только когда лифт стоит на этаже вызова"
}
```

### GET /status
Текущий статус системы.

- Успешный ответ (пример):
```json
{
  "status": "moving",
  "floor": 3,
  "direction": "up",
  "route": "5,7,10"
}
```

## Алгоритм и поведение

- Алгоритм маршрутизации: SCAN
    - Лифт обрабатывает все цели в текущем направлении (вверх или вниз), затем разворачивается.
    - Вызовы (этажи, где нужно забрать пассажиров) и назначения (этажи, куда ехать) объединяются, формируя упорядоченный маршрут.
- Вызов (`/call`) добавляет этаж в очередь запросов и немедленно возвращает ответ.
- Выбор назначения (`/select`) разрешён только при остановке лифта на этаже вызова (модель «двери открыты» на короткое время).
- Статус (`/status`) возвращает:
    - `status`: `moving` или `idle` (или человекочитаемое состояние)
    - `floor`: текущий этаж
    - `direction`: `up` | `down` | `idle`
    - `route`: ближайшие этажи в порядке посещения

## Примеры cURL

- Вызвать лифт на 3 этаж:
```bash
curl -X POST http://localhost:8000/call -H "Content-Type: application/json" -d '{"floor":3}'
```

- Проверить статус:
```bash
curl http://localhost:8000/status
```

- Когда лифт прибыл на этаж вызова — выбрать этаж назначения (например, 7):
```bash
curl -X POST http://localhost:8000/select -H "Content-Type: application/json" -d '{"floor":7}'
```

## Тестирование

- Запуск pytest локально:
```bash
pytest -v
```

- В docker-compose:
```bash
docker-compose run --rm elevator-tests
```

## Лицензия

См. `LICENSE`.